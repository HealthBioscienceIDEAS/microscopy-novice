<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><title>Image Analysis for Microscopy: Filters and thresholding</title><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="stylesheet" type="text/css" href="assets/styles.css"><script src="assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png"><link rel="manifest" href="site.webmanifest"><link rel="mask-icon" href="safari-pinned-tab.svg" color="#5bbad5"><meta name="msapplication-TileColor" content="#da532c"><meta name="theme-color" content="#ffffff"></head><body>
    <header id="top" class="navbar navbar-expand-md navbar-light bg-white top-nav IDEAS"><a class="visually-hidden-focusable skip-link" href="#main-content">Skip to main content</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-6">
      <div class="large-logo">
        <img alt="IDEAS" src="assets/images/IDEAS-logo.svg"><abbr class="badge badge-light" title="This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught." style="background-color: #FF4955; border-radius: 5px">
          <a href="https://cdh.carpentries.org/the-lesson-life-cycle.html#early-development-pre-alpha-through-alpha" class="external-link alert-link" style="color: #000">
            <i aria-hidden="true" class="icon" data-feather="alert-octagon" style="border-radius: 5px"></i>
            Pre-Alpha
          </a>
          <span class="visually-hidden">This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught.</span>
        </abbr>

      </div>
    </div>
    <div class="selector-container">


      <div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Learner View <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1"><li><button class="dropdown-item" type="button" onclick="window.location.href='instructor/filters-and-thresholding.html';">Instructor View</button></li>
        </ul></div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl navbar-light bg-white bottom-nav IDEAS" aria-label="Main Navigation"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle Navigation">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="IDEAS" src="assets/images/IDEAS-logo-sm.svg"></div>
    <div class="lesson-title-md">
      Image Analysis for Microscopy
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
        <i role="img" aria-label="Search the All In One page" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class="nav-item">
          <span class="lesson-title">
            Image Analysis for Microscopy
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="key-points.html">Key Points</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="reference.html#glossary">Glossary</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="profiles.html">Learner Profiles</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            More <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown"><li><a class="dropdown-item" href="reference.html">Reference</a></li>
          </ul></li>
      </ul></div>
    <!--
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled>
      <input class="form-control me-2 searchbox" type="search" placeholder="" aria-label="">
        <button class="btn btn-outline-success tablet-search-button"  type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="Search the All In One page"></i>
        </button>
      </fieldset>
    </form>
    -->
    <a class="btn btn-primary" href="aio.html" role="button" aria-label="Search the All In One page">Search the All In One page</a>
  </div><!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  Image Analysis for Microscopy
</div>

<aside class="col-md-12 lesson-progress"><div style="width: 77%" class="percentage">
    77%
  </div>
  <div class="progress IDEAS">
    <div class="progress-bar IDEAS" role="progressbar" style="width: 77%" aria-valuenow="77" aria-label="Lesson Progress" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
<div id="sidebar-col" class="col-lg-4">
  <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="close menu" alt="close menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle" data-collapse="Collapse " data-episodes="Episodes ">
          <i class="search-icon" data-feather="x" role="img"></i>
        </button>
        <div class="sidebar-inner">
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Learner View
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="instructor/filters-and-thresholding.html">Instructor View</a>
                      </div>
                    </div>
                  </div><!--/div.accordion-item-->
                </div><!--/div.accordion-flush-->
              </div><!--div.sidenav-view-selector -->
            </div><!--/div.col -->

            <hr></div><!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODES
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Summary and Setup</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="imaging-software.html">1. Imaging Software</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush3">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading3">
        <a href="what-is-an-image.html">2. What is an image?</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush4">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading4">
        <a href="image-display.html">3. Image display</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush5">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading5">
        <a href="multi-dimensional-images.html">4. Multi-dimensional images</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush6">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading6">
        <a href="filetypes-and-metadata.html">5. Filetypes and metadata</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush7">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading7">
        <a href="designing-a-light-microscopy-experiment.html">6. Designing a light microscopy experiment</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush8">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading8">
        <a href="choosing-acquisition-settings.html">7. Choosing acquisition settings</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush9">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading9">
        <a href="quality-control-and-manual-segmentation.html">8. Quality control and manual segmentation</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlushcurrent">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-headingcurrent">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapsecurrent" aria-expanded="true" aria-controls="flush-collapsecurrent">
        <span class="visually-hidden">Current Chapter</span>
        <span class="current-chapter">
        9. Filters and thresholding
        </span>
      </button>
    </div><!--/div.accordion-header-->

    <div id="flush-collapsecurrent" class="accordion-collapse collapse show" aria-labelledby="flush-headingcurrent" data-bs-parent="#accordionFlushcurrent">
      <div class="accordion-body">
        <ul><li><a href="#thresholding">Thresholding</a></li>
<li><a href="#adding-plugins-to-help-with-segmentation">Adding plugins to help with segmentation</a></li>
<li><a href="#filters">Filters</a></li>
<li><a href="#thresholding-the-blurred-image">Thresholding the blurred image</a></li>
<li><a href="#automated-thresholding">Automated thresholding</a></li>
<li><a href="#summary">Summary</a></li>
        </ul></div><!--/div.accordion-body-->
    </div><!--/div.accordion-collapse-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush11">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading11">
        <a href="instance-segmentation-and-measurements.html">10. Instance segmentation and measurements</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush12">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading12">
        <a href="additional-resources.html">11. Additional resources</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width"><div class="accordion accordion-flush resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RESOURCES
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul><li>
                        <a href="key-points.html">Key Points</a>
                      </li>
                      <li>
                        <a href="reference.html#glossary">Glossary</a>
                      </li>
                      <li>
                        <a href="profiles.html">Learner Profiles</a>
                      </li>
                      <li><a href="reference.html">Reference</a></li>
                    </ul></div>
                </div>
              </div>
            </div>
            <hr class="half-width resources"><a href="aio.html">See all in one page</a>


            <hr class="d-none d-sm-block d-md-none"><div class="d-grid gap-1">

            </div>
          </div><!-- /div.accordion -->
        </div><!-- /div.sidebar-inner -->
      </nav></div><!-- /div.sidebar -->
  </div><!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-instructor.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <nav class="lesson-content mx-md-4" aria-label="Previous and Next Chapter"><!-- content for small screens --><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="quality-control-and-manual-segmentation.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="instance-segmentation-and-measurements.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="quality-control-and-manual-segmentation.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Previous: Quality control and
        </a>
        <a class="chapter-link float-end" href="instance-segmentation-and-measurements.html" rel="next">
          Next: Instance...
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
      <hr></nav><main id="main-content" class="main-content"><div class="container lesson-content">
        <h1>Filters and thresholding</h1>
        <p>Last updated on 2025-11-21 |

        <a href="https://github.com/HealthBioscienceIDEAS/microscopy-novice/edit/main/episodes/filters-and-thresholding.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>



        <div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>

        

<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul><li>How can thresholding be used to create masks?</li>
<li>What are filters and how do they work?</li>
</ul></div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul><li><p>Threshold an image manually using its histogram, and display the
result in Napari</p></li>
<li><p>Use some Napari plugins to perform two commonly used image
processing steps: gaussian blurring and otsu thresholding</p></li>
<li><p>Explain how filters work - e.g. what is a kernel? What does the
‘sigma’ of a gaussian blur change?</p></li>
<li><p>Explain the difference between Napari’s
<code>.add_labels()</code> and <code>.add_image()</code></p></li>
</ul></div>
</div>
</div>
</div>
</div>
<p>In the previous episode, we started to develop an image processing
workflow to count the number of cells in an image. Our initial pipeline
relied on manual segmentation:</p>
<ol style="list-style-type: decimal"><li>Quality Control</li>
<li>Manual segmentation of nuclei</li>
<li>Count nuclei</li>
</ol><p>There are a number of issues with relying on manual segmentation for
this task. For example, as covered in the <a href="quality-control-and-manual-segmentation.html#manual-vs-automated">previous
episode</a>, it is difficult to keep manual segmentation fully
consistent. If you ask someone to segment the same cell multiple times,
the result will always be slightly different. Also, manual segmentation
is very slow and time consuming! While it is feasible for small images
in small quantities, it would take much too long for large datasets of
hundreds or thousands of images.</p>
<p>This is where we need to introduce more automated methods, which we
will start to look at in this episode. Most importantly, using more
automated methods has the benefit of making your image processing more
<em>reproducible</em> - by having a clear record of every step that
produced your final result, it will be easier for other researchers to
replicate your work and also try similar methods on their own data.</p>
<section><h2 class="section-heading" id="thresholding">Thresholding<a class="anchor" aria-label="anchor" href="#thresholding"></a></h2>
<hr class="half-width"><p>If you don’t have Napari’s ‘Cells (3D + 2Ch)’ image open, then open
it with:<br><code>File &gt; Open Sample &gt; napari builtins &gt; Cells (3D + 2Ch)</code></p>
<p>Make sure you only have ‘nuclei’ in the layer list. Select any
additional layers, then click the <img src="https://raw.githubusercontent.com/napari/napari/main/src/napari/resources/icons/delete.svg" alt="A screenshot of Napari's delete layer button" height="30" class="figure">
icon to remove them. Also, select the nuclei layer (should be
highlighted in blue), and change its colormap from ‘green’ to ‘gray’ in
the layer controls.</p>
<figure><img src="fig/nuclei-gray-napari.png" alt="A screenshot of nuclei in Napari using  the gray colormap" class="figure mx-auto d-block"></figure><p>Now let’s look at how we can create a mask of the nuclei. Recall from
the <a href="quality-control-and-manual-segmentation.html">last
episode</a>, that a ‘mask’ is a segmentation with only two labels -
background + your class of interest (in this case nuclei).</p>
<p>A simple approach to create a mask is to use a method called
‘thresholding’. Thresholding works best when there is a clear separation
in pixel values between the class of interest and the rest of the image.
In these cases, thresholding involves choosing one or more specific
pixel values to use as the cut-off between background and your class of
interest. For example, in this image, you could choose a pixel value of
100 and set all pixels with a value less than that as background, and
all pixels with a value greater than that as nuclei. How do we go about
choosing a good threshold though?</p>
<p>One common approach to choosing a threshold is to use the image
histogram - recall that we looked at histograms in detail in the <a href="image-display.html">image display episode</a>. Let’s go ahead and
open a histogram with:<br><code>Plugins &gt; napari Matplotlib &gt; Histogram</code></p>
<figure><img src="fig/nuclei-histogram.png" alt="A histogram of the 29th z slice of Napari's  cell sample image" class="figure mx-auto d-block"></figure><p>From this histogram, we can see two peaks - a larger one at low
intensity, then a smaller one at higher intensity. Looking at the image,
it would make sense if the lower intensity peak represented the
background, with the higher one representing the nuclei. We can verify
this by adjusting the contrast limits in the layer controls. If we move
the left contrast limits node to the right of the low intensity peak
(around 8266), we can still clearly see the nuclei:</p>
<figure><img src="fig/contrast-limit-8266-nuclei.png" alt="Left, nuclei with gray colormap.  Right, histogram of the same image. Both with left contrast limit set  to 8266." class="figure mx-auto d-block"></figure><p>If we move the left contrast limits node to the right of the higher
intensity peak (around 28263), most of the nuclei disappear from the
image:</p>
<figure><img src="fig/contrast-limit-28263-nuclei.png" alt="Left, nuclei with gray colormap.  Right, histogram of the same image. Both with left contrast limit set  to 28263." class="figure mx-auto d-block"></figure><p>Recall that you can set specific values for the contrast limits by
right clicking on the contrast limits slider in Napari.</p>
<p>This demonstrates that the higher intensity peak is the one we are
interested in, and we should set our threshold accordingly.</p>
<p>We can set this threshold with some commands in Napari’s console:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="co"># Get the image data for the nuclei</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>nuclei <span class="op">=</span> viewer.layers[<span class="st">"nuclei"</span>].data</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="co"># Create mask with a threshold of 8266</span></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a>mask <span class="op">=</span> nuclei <span class="op">&gt;</span> <span class="dv">8266</span></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a><span class="co"># Add mask to the Napari viewer</span></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a>viewer.add_labels(mask)</span></code></pre>
</div>
<p>You should see a mask appear that highlights the nuclei in brown. If
we set the nuclei contrast limits back to normal (select ‘nuclei’ in the
layer list, then drag the left contrast limits node back to zero), then
toggle on/off the mask or nuclei layers with the <img src="https://raw.githubusercontent.com/napari/napari/main/src/napari/resources/icons/visibility.svg" alt="A screenshot of Napari's eye button" height="30" class="figure"> icon, you
should see that the brown areas match the nucleus boundaries reasonably
well. They aren’t perfect though! The brown regions have a speckled
appearance where some regions inside nuclei aren’t labelled and some
areas in the background are incorrectly labelled.</p>
<figure><img src="fig/threshold-mask.png" style="width:60.0%" alt="Mask of nuclei (brown) overlaid on nuclei  image - created with manual thresholding" class="figure mx-auto d-block"></figure><p>This is mostly due to the presence of noise in our image (as we
looked at in the <a href="choosing-acquisition-settings.html#signal-to-noise-ratio">choosing
acquisition settings episode</a>). For example, the dark image
background isn’t completely uniform - there are random fluctuations in
the pixel values giving it a ‘grainy’ appearance when we zoom in. These
fluctuations in pixel value make it more difficult to set a threshold
that fully separates the nuclei from the background. For example,
background pixels that are brighter than average may exceed our
threshold of 8266, while some nuclei pixels that are darker than average
may fall below it. This is the main cause of the speckled appearance of
some of our mask regions.</p>
<p>To improve the mask we must find a way to reduce these fluctuations
in pixel value. This is usually achieved by blurring the image (also
referred to as smoothing). We’ll look at this in detail <a href="#filters">later in the episode</a>.</p>
<div id="add_labels-vs-.add_image" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<span class="callout-header">Callout</span>
<div id="add_labels-vs-.add_image" class="callout-inner">
<h3 class="callout-title">
<code>.add_labels()</code> vs
<code>.add_image</code>
</h3>
<div class="callout-content">
<p>In the code blocks above, you will notice that we use
<code>.add_labels()</code>, rather than <code>.add_image()</code> as we
have in previous episodes. <code>.add_labels()</code> will ensure our
mask is added as a <code>Labels</code> layer, giving us access to all
the annotation tools and settings for segmentations (as covered in the
<a href="quality-control-and-manual-segmentation.html">manual
segmentation episode</a>). <code>add_image()</code> would create a
standard <code>Image</code> layer, which doesn’t give us easy access to
the annotation tools.</p>
</div>
</div>
</div>
<div id="manual-thresholds" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<span class="callout-header">Challenge</span>
<div id="manual-thresholds" class="callout-inner">
<h3 class="callout-title">Manual thresholds</h3>
<div class="callout-content">
<p>In this exercise, we’ll practice choosing manual thresholds based on
an image’s histogram. For this, we’ll use a simple test image containing
three shapes (rectangle, circle and triangle) with different mean
intensities.</p>
<p>Copy and paste the following into Napari’s console to generate and
load this test image:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="im">import</span> skimage</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="im">from</span> skimage.draw <span class="im">import</span> disk, polygon</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="im">from</span> skimage.util <span class="im">import</span> random_noise, img_as_ubyte</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a><span class="im">from</span> packaging <span class="im">import</span> version</span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>image <span class="op">=</span> np.full((<span class="dv">100</span>, <span class="dv">100</span>), <span class="dv">10</span>, dtype<span class="op">=</span><span class="st">"uint8"</span>)</span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>image[<span class="dv">10</span>:<span class="dv">50</span>, <span class="dv">20</span>:<span class="dv">80</span>] <span class="op">=</span> <span class="dv">200</span></span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a>image[disk((<span class="dv">75</span>, <span class="dv">75</span>), <span class="dv">15</span>)] <span class="op">=</span> <span class="dv">140</span></span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a>rr, cc <span class="op">=</span> polygon([<span class="dv">90</span>, <span class="dv">60</span>, <span class="dv">90</span>], [<span class="dv">10</span>, <span class="dv">30</span>, <span class="dv">50</span>])</span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a>image[rr, cc] <span class="op">=</span> <span class="dv">80</span></span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a><span class="cf">if</span> version.parse(skimage.__version__) <span class="op">&lt;</span> version.parse(<span class="st">"0.21"</span>):</span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a>  image <span class="op">=</span> img_as_ubyte(random_noise(image, var<span class="op">=</span><span class="fl">0.0005</span>, seed<span class="op">=</span><span class="dv">6</span>))</span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a>  image <span class="op">=</span> img_as_ubyte(random_noise(image, var<span class="op">=</span><span class="fl">0.0005</span>, rng<span class="op">=</span><span class="dv">6</span>))</span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a>viewer.add_image(image)</span></code></pre>
</div>
<figure><img src="fig/shapes.png" style="width:50.0%" alt="Test image containing a  rectangle, circle and triangle" class="figure mx-auto d-block"></figure><p>Create a mask for each shape by choosing thresholds based on the
image’s histogram. You can set a threshold as all pixels above a certain
value:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>mask <span class="op">=</span> image <span class="op">&gt;</span> <span class="dv">40</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>viewer.add_labels(mask)</span></code></pre>
</div>
<p>Or all pixels below a certain value:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>mask <span class="op">=</span> image <span class="op">&lt;</span> <span class="dv">40</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>viewer.add_labels(mask)</span></code></pre>
</div>
<p>Or all pixels between two values:</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>mask <span class="op">=</span> (image <span class="op">&gt;</span> <span class="dv">20</span>) <span class="op">&amp;</span> (image <span class="op">&lt;</span> <span class="dv">40</span>)</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>viewer.add_labels(mask)</span></code></pre>
</div>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<p>First, we show a histogram for the image by selecting the ‘image’
layer, then:<br><code>Plugins &gt; napari Matplotlib &gt; Histogram</code></p>
<figure><img src="fig/shapes-histogram.png" alt="Histogram of the  shape image" class="figure mx-auto d-block"></figure><p>By moving the left contrast limits node we can figure out what each
peak represents. You should see that the peaks from left to right
are:</p>
<ul><li>background</li>
<li>triangle</li>
<li>circle</li>
<li>rectangle</li>
</ul><p>Then we set thresholds for each (as below). Note that you may not
have exactly the same threshold values as we use here! There are many
different values that can give good results, as long as they fall in the
gaps between the peaks in the image histogram.</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>rectangle <span class="op">=</span> image <span class="op">&gt;</span> <span class="dv">171</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>viewer.add_labels(rectangle)</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>circle <span class="op">=</span> (image <span class="op">&gt;</span> <span class="dv">118</span>) <span class="op">&amp;</span> (image <span class="op">&lt;</span> <span class="dv">166</span>)</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>viewer.add_labels(circle)</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>triangle <span class="op">=</span> (image <span class="op">&gt;</span> <span class="dv">53</span>) <span class="op">&amp;</span> (image <span class="op">&lt;</span> <span class="dv">110</span>)</span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>viewer.add_labels(triangle)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="adding-plugins-to-help-with-segmentation">Adding plugins to help with segmentation<a class="anchor" aria-label="anchor" href="#adding-plugins-to-help-with-segmentation"></a></h2>
<hr class="half-width"><p>Fortunately for us, segmenting images in the presence of noise is a
widely studied problem, so there are a many existing plugins we can
install to help. If you need a refresher on the details of how to find
and install plugins in Napari, see the <a href="image-display.html#napari-plugins">image display episode</a>.</p>
<p>We will use the <a href="https://napari-hub.org/plugins/napari-skimage.html" class="external-link"><code>napari-skimage</code></a>
plugin, which adds many features that can aid with image segmentation
and other image processing tasks.</p>
<p>In the top menu-bar of Napari select:<br><code>Plugins &gt; Install/Uninstall Plugins...</code></p>
<p>Then search for <code>napari-skimage</code> and click the blue button
labelled ‘install’. Wait for the installation to complete.</p>
<figure><img src="fig/napari-skimage-installation.png" alt="Screenshot of plugin  installation window for napari-skimage" class="figure mx-auto d-block"></figure><p>Once the plugin is installed, <strong>you will need to close and
re-open Napari</strong>.</p>
</section><section><h2 class="section-heading" id="filters">Filters<a class="anchor" aria-label="anchor" href="#filters"></a></h2>
<hr class="half-width"><p>Let’s open the cells image in Napari again:<br><code>File &gt; Open Sample &gt; napari builtins &gt; Cells (3D + 2Ch)</code></p>
<p>As before, make sure you only have ‘nuclei’ in the layer list. Select
any additional layers, then click the <img src="https://raw.githubusercontent.com/napari/napari/main/src/napari/resources/icons/delete.svg" alt="A screenshot of Napari's delete layer button" height="30" class="figure">
icon to remove them. Also, select the nuclei layer (should be
highlighted in blue), and change its colormap from ‘green’ to ‘gray’ in
the layer controls.</p>
<figure><img src="fig/nuclei-gray.png" style="width:40.0%" alt="Nuclei image with gray colormap" class="figure mx-auto d-block"></figure><p>With the new plugin installed, you should see many new options under
<code>Layers</code> in the top menu-bar of Napari. You can find out more
about these options using the <a href="https://github.com/guiwitz/napari-skimage/blob/main/README.md" class="external-link">plugin’s
documentation</a>.</p>
<p>For now, we are interested in the <em>gaussian blur</em> under:<br><code>Layers &gt; Filter &gt; Filtering &gt; Gaussian filter (napari-skimage)</code></p>
<p>If you click on this option, you should see a new panel appear on the
right side of Napari:</p>
<figure><img src="fig/gaussian-options.png" style="width:40.0%" alt="Screenshot of settings for gaussian blur in  Napari" class="figure mx-auto d-block"></figure><p>Make sure you have ‘nuclei’ selected on the ‘image’ row, then click
‘Apply Gaussian Filter’:</p>
<figure><img src="fig/nuclei-blurred-1.png" style="width:40.0%" alt="Nuclei image after gaussian blur with sigma  of 1" class="figure mx-auto d-block"></figure><p>You should see a new image appear in the layer list called
‘nuclei_gaussian_σ=1.0’, which is a slightly blurred version of the
original nuclei image.</p>
<p>Try increasing the ‘sigma’ value to three and clicking run again:</p>
<figure><img src="fig/nuclei-blurred-3.png" style="width:40.0%" alt="Nuclei image after gaussian blur with sigma  of 3" class="figure mx-auto d-block"></figure><p>You should see a new ‘nuclei_gaussian_σ=3.0’ layer that is much more
heavily blurred. If you used the <code>+</code>/<code>-</code> buttons
to set the sigma value, you may see many more decimal places in the
layer name e.g. ‘nuclei_gaussian_σ=3.00000000000000’. If so, double
click on the layer name to re-name it to
<code>nuclei_gaussian_σ=3.0</code>.</p>
<p>What’s happening here? What exactly does a gaussian blur do? A
gaussian blur is an example of a ‘linear filter’ which is used to
manipulate pixel values in images. When a filter is applied to an image,
each pixel value is replaced by some combination of the pixel values
around it. For example, below is shown a small, zoomed-in area of the
nucleus image. Here, the value of the red pixel could be affected by all
values within the displayed 3x3 box:</p>
<figure><img src="fig/nuclei-kernel-area.png" style="width:60.0%" alt="Small zoomed-in area of the nucleus image  with a pixel highlighted in red. Around this pixel is shown a  3x3 box." class="figure mx-auto d-block"></figure><p>Exactly what this effect is, and the size of the region it involves,
is controlled by the filter’s ‘kernel’. The kernel can be thought of as
another very small image, where the pixel values control the effect of
the filter. An example 3x3 kernel is shown below:</p>
<figure><img src="fig/nuclei-kernel.png" alt="Left - small area of the nucleus image with a  pixel highlighted in red. Around this pixel is shown a 3x3 box. Right - example  of a 3x3 kernel" class="figure mx-auto d-block"></figure><p>While the above image uses a 3x3 kernel, they can have many different
sizes! Kernels tend to be odd in size: 3x3, 5x5, 9x9, etc. This is to
allow the current pixel that you will be replacing to lie perfectly at
the centre of the kernel, with equal spacing on all sides.</p>
<p>To determine the new value of a pixel (like the red pixel above), the
kernel is placed over the target image centred on the pixel of interest.
Then, for each position in the kernel, we multiply the image pixel value
with the kernel pixel value. For the 3x3 kernel example above, we
multiply the image pixel value one above and one to the left of our
current pixel with the pixel value in the top left position of the
kernel. Then we multiply the value for the pixel just above our current
pixel with the top middle kernel value and so on… The result of the nine
multiplications in each of the nine positions of this kernel are then
summed together to give the new value of the central pixel. To process
an entire image, the kernel is moved across the image pixel by pixel
calculating the new value at each location. Pete Bankhead’s bioimage
book has a <a href="https://bioimagebook.github.io/chapters/2-processing/4-filters/filters.html#mean-filters" class="external-link">really
nice animation of this process</a> , which is worth taking a look
at.</p>
<p>For the gaussian filter we looked at above, the values in the kernel
are based on a ‘gaussian function’. A gaussian function creates a
central peak that reduces in height as we move further away from the
centre. The shape of the peak can be adjusted using different values of
‘sigma’ (the standard deviation of the function), with larger sigma
values resulting in a wider peak:</p>
<figure><img src="fig/gaussian-1d-comparison.png" alt="Plot of a 1D gaussian function  comparing three different sigma values" class="figure mx-auto d-block"></figure><p>For a gaussian filter, the values are based on a 2D gaussian
function. This gives similar results to the plot above (showing a 1D
gaussian function) with a clear central peak, but now the height
decreases in both x and y:</p>
<figure><img src="fig/gaussian-2d-comparison.png" alt="Plot of a 2D gaussian function  comparing three different sigma values" class="figure mx-auto d-block"></figure><p>Gaussian kernels show this same pattern, with values highest at the
centre that decrease as we move further away. See the example 5x5 kernel
below:</p>
<figure><img src="fig/gaussian-kernel.png" style="width:40.0%" alt="An example of a 5x5 gaussian  kernel" class="figure mx-auto d-block"></figure><p>The gaussian filter causes blurring (also known as smoothing), as it
is equivalent to taking a weighted average of all pixel values within
its boundaries. In a weighted average, some values contribute more to
the final result than others. This is determined by their ‘weight’, with
a higher weight resulting in a larger contribution to the result. As a
gaussian kernel has its highest weights at the centre, this means that a
gaussian filter produces an average where central pixels contribute more
than those further away.</p>
<p>Larger sigma values result in larger kernels, which average larger
areas of the image. For example, the <a href="https://scikit-image.org/docs/stable/api/skimage.filters.html#skimage.filters.gaussian" class="external-link"><code>scikit-image</code></a>
implementation we are currently using truncates the kernel after four
standard deviations (sigma). This means that the blurring effect of the
gaussian filter is enhanced with larger sigma, but will also take longer
to calculate. This is a general feature of kernels for different types
of filter - larger kernels tend to result in a stronger effect at the
cost of increased compute time. This time can become significant when
processing very large images in large quantities.</p>
<p>If you want more information about how filters work, both the <a href="https://datacarpentry.org/image-processing/06-blurring.html" class="external-link">data
carpentry image processing lesson</a> and Pete Bankhead’s <a href="https://bioimagebook.github.io/chapters/2-processing/4-filters/filters.html" class="external-link">bioimage
book</a> have chapters going into great detail. Note that here we have
focused on ‘linear’ filters, but there are many types of ‘non-linear’
filter that process pixel values in different ways.</p>
<div id="sigma-vs-full-width-at-half-maximum-fwhm" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<span class="callout-header">Callout</span>
<div id="sigma-vs-full-width-at-half-maximum-fwhm" class="callout-inner">
<h3 class="callout-title">Sigma vs full width at half maximum
(FWHM)</h3>
<div class="callout-content">
<p>In this episode, we have focused on the gaussian function’s standard
deviation (sigma) as the main way to control the width of the central
peak. Some image analysis packages will instead use a measure called the
‘full width at half maximum’ or FWHM. The FWHM is the width of the curve
at half of its maximum value (see the diagram below):</p>
<figure><img src="fig/gaussian-FWHM.png" style="width:80.0%" alt="Diagram of gaussian function with FWHM labelled" class="figure mx-auto d-block"></figure><p>Similar to increasing sigma, a higher FWHM will result in a wider
peak. Note that there is a clear relationship between sigma and FWHM
where:</p>
<p><span class="math display">\[\large FWHM =
sigma\sqrt{8ln(2)}\]</span></p>
</div>
</div>
</div>
<div id="filters-1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<span class="callout-header">Challenge</span>
<div id="filters-1" class="callout-inner">
<h3 class="callout-title">Filters</h3>
<div class="callout-content">
<p>Try some of the other filters included with the
<code>napari-skimage</code> plugin. Some of these only support 2D images
for now (the plugin is still being actively updated - so more 3D support
should be added soon).</p>
<p>Create a 2D image by running the following in the console:</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>nuclei <span class="op">=</span> viewer.layers[<span class="st">"nuclei"</span>].data</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>viewer.add_image(nuclei[<span class="dv">30</span>, :, :], name<span class="op">=</span><span class="st">"nuclei_2D"</span>)</span></code></pre>
</div>
<p>Try the following filters (make sure you use ‘nuclei_2D’ in the image
field):</p>
<ul><li><p>What does
<code>Layers &gt; Filter &gt; Filtering &gt; Median filter (napari skimage)</code>
do? How does it compare to the gaussian filter we used earlier?</p></li>
<li><p>What does
<code>Layers &gt; Filter &gt; Edge detection &gt; Farid filter (napari skimage)</code>
do?</p></li>
<li>
<p>What does
<code>Layers &gt; Filter &gt; Filtering &gt; Rank filters (napari skimage)</code>
do?</p>
<ul><li>Try a ‘Filter Type’ of ‘Maximum` and ’Minimum’ + compare</li>
<li>(you may say see a warning relating to bin number when you run this
- this can be ignored)</li>
</ul></li>
</ul><p>If you’re not sure what the effect is, try searching for the filter’s
name online.</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" aria-labelledby="headingSolution2" data-bs-parent="#accordionSolution2">
<div class="accordion-body">
<div class="section level3">
<h3 id="median">Median<a class="anchor" aria-label="anchor" href="#median"></a></h3>
<p>The median filter creates a blurred version of the input image.
Larger values for the ‘Footprint size’ result in a greater blurring
effect.</p>
<p>The results of the median filter are similar to a gaussian blur, but
tend to preserve the edges of objects better. For example, here you can
see that it preserves the sharp edges of each nucleus. You can read more
about how the median filter works in Pete Bankhead’s <a href="https://bioimagebook.github.io/chapters/2-processing/4-filters/filters.html#rank-filters" class="external-link">bioimage
book</a>.</p>
</div>
<div class="section level3">
<h3 id="farid">Farid<a class="anchor" aria-label="anchor" href="#farid"></a></h3>
<p>Farid is a type of filter used to detect the edges of objects in an
image. For example, for the nuclei image it gives bright rings around
each nucleus, as well as around some of the brighter patches inside the
nuclei.</p>
</div>
<div class="section level3">
<h3 id="maximum">Maximum<a class="anchor" aria-label="anchor" href="#maximum"></a></h3>
<p>A maximum filter replaces each pixel value with the maximum value in
a certain area around it. For example, for the nuclei, you should see
the bright areas expand in size. Increasing the ‘Footprint size’ of the
filter enhances the effect.</p>
</div>
<div class="section level3">
<h3 id="minimum-filter">Minimum filter<a class="anchor" aria-label="anchor" href="#minimum-filter"></a></h3>
<p>A minimum filter replaces each pixel value with the minimum value in
a certain area around it. For example, for the nuclei, you should see
the bright areas shrink in size. Increasing the ‘Footprint size’ of the
filter enhances the effect.</p>
</div>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="thresholding-the-blurred-image">Thresholding the blurred image<a class="anchor" aria-label="anchor" href="#thresholding-the-blurred-image"></a></h2>
<hr class="half-width"><p>First, let’s clean up our layer list. Make sure you only have the
‘nuclei’ layer in the layer list - select any others and remove them by
clicking the <img src="https://raw.githubusercontent.com/napari/napari/main/src/napari/resources/icons/delete.svg" alt="A screenshot of Napari's delete layer button" height="30" class="figure">
icon. Also, close all filter settings panels on the right side of Napari
(apart from the gaussian settings) by clicking the tiny <code>X</code>
icon at their top left corner.</p>
<p>Now let’s try thresholding our image again. Make sure you set your
gaussian blur sigma to three, then click ‘Apply Gaussian Filter’.</p>
<p>Then, we’ll apply the same threshold as before, now to the
‘nuclei_gaussian_σ=3.0’ layer:</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a><span class="co"># Get the image data for the blurred nuclei</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>blurred <span class="op">=</span> viewer.layers[<span class="st">"nuclei_gaussian_σ=3.0"</span>].data</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a><span class="co"># Create mask with a threshold of 8266</span></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>blurred_mask <span class="op">=</span> blurred <span class="op">&gt;</span> <span class="dv">8266</span></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a><span class="co"># Add mask to the Napari viewer</span></span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a>viewer.add_labels(blurred_mask)</span></code></pre>
</div>
<p>You’ll see that we get an odd result - a totally empty image! What
went wrong here? Let’s look at the blurred image’s shape and data type
in the console:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="bu">print</span>(blurred.shape)</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="bu">print</span>(blurred.dtype)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>(60, 256, 256)
float64</code></pre>
</div>
<p>The shape is as expected, but what happened to the data type! It’s
now a 64-bit float image (rather than the usual unsigned integer
8-bit/16-bit for images). Recall from the <a href="what-is-an-image.html#type">‘What is an image?’ episode</a> that
float images allow values with a decimal point to be stored
e.g. 3.14.</p>
<p>Many image processing operations will convert images to
<code>float32</code> or <code>float64</code>, to provide the highest
precision possible. For example, imagine you have an unsigned-integer
8-bit image with pixel values of all 75. If you divided by two to give
37.5, then these values would all be rounded to 38 when stored (as
<code>uint8</code> can’t store decimal numbers). Only by converting to a
different data type (float) could we store the exact value of this
operation. In addition, by having the highest bit-depth (64-bit), we
ensure the highest possible precision which can be useful to avoid
slight errors after multiple operations are applied one after the other.
In summary, changes in data type are expected in image processing, and
it’s good to keep an eye out for when this is required!</p>
<p>Let’s return to thresholding our image. Close the gaussian panel by
clicking the tiny <code>X</code> icon at its top left corner. Then
select the ‘blurred_mask’ in the layer list and remove it by clicking
the <img src="https://raw.githubusercontent.com/napari/napari/main/src/napari/resources/icons/delete.svg" alt="A screenshot of Napari's delete layer button" height="30" class="figure">
icon. Finally, open the <code>napari-matplotlib</code> histogram again
with:<br><code>Plugins &gt; napari Matplotlib &gt; Histogram</code></p>
<figure><img src="fig/blurred-nuclei-histogram.png" alt="A histogram of the 29th z slice of  the nuclei image after a gaussian blur. The left contrast limit is set  to 0.134." class="figure mx-auto d-block"></figure><p>Make sure you have ‘nuclei_gaussian_σ=3.0’ selected in the layer list
(should be highlighted in blue).</p>
<p>You should see that this histogram now runs from 0 to 1, reflecting
the new values after the gaussian blur and its new data type. Let’s
again choose a threshold between the two peaks - around 0.134:</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="co"># Get the image data for the blurred nuclei</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>blurred <span class="op">=</span> viewer.layers[<span class="st">"nuclei_gaussian_σ=3.0"</span>].data</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a><span class="co"># Create mask with a threshold of 0.134</span></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>blurred_mask <span class="op">=</span> blurred <span class="op">&gt;</span> <span class="fl">0.134</span></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a><span class="co"># Add mask to the Napari viewer</span></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a>viewer.add_labels(blurred_mask)</span></code></pre>
</div>
<figure><img src="fig/threshold-blurred-mask.png" style="width:60.0%" alt="Mask of nuclei (brown) overlaid on  nuclei image - created with manual thresholding after gaussian blur" class="figure mx-auto d-block"></figure><p>Now we see a much more sensible result - a brown mask that again
highlights the nuclei in brown. To compare to the result with no
smoothing, let’s run our previous threshold again (from the <a href="#thresholding">earlier thresholding section</a>):</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a><span class="co"># Get the image data for the nuclei</span></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>nuclei <span class="op">=</span> viewer.layers[<span class="st">"nuclei"</span>].data</span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a><span class="co"># Create mask with a threshold of 8266</span></span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a>mask <span class="op">=</span> nuclei <span class="op">&gt;</span> <span class="dv">8266</span></span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a><span class="co"># Add mask to the Napari viewer</span></span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a>viewer.add_labels(mask)</span></code></pre>
</div>
<p>If we compare ‘blurred_mask’ and ‘mask’, we can see that blurring
before choosing a threshold results in a much smoother result that has
fewer areas inside nuclei that aren’t labelled, as well as fewer areas
of the background that are incorrectly labelled.</p>
<p>This workflow of blurring an image then thresholding it is a very
common method to provide a smoother, more complete mask. Note that it
still isn’t perfect! If you browse through the z slices with the slider
at the bottom of the image, it’s clear that some areas are still missed
or incorrectly labelled.</p>
</section><section><h2 class="section-heading" id="automated-thresholding">Automated thresholding<a class="anchor" aria-label="anchor" href="#automated-thresholding"></a></h2>
<hr class="half-width"><p>First, let’s clean up our layer list again. Make sure you only have
the ‘nuclei’, ‘mask’, ‘blurred_mask’ and ‘nuclei_gaussian_σ=3.0’ layers
in the layer list - select any others and remove them by clicking the
<img src="https://raw.githubusercontent.com/napari/napari/main/src/napari/resources/icons/delete.svg" alt="A screenshot of Napari's delete layer button" height="30" class="figure">
icon. Then, if you still have the <code>napari-matplotlib</code>
histogram open, close it by clicking the tiny <code>x</code> icon in the
top left corner.</p>
<p>So far we have chosen our threshold manually by looking at the image
histogram, but it would be better to find an automated method to do this
for us. Many such methods exist - for example, open
<code>Layers &gt; Filter &gt; Thresholding &gt; Automated Threshold (napari skimage)</code>.
One of the most common methods is <em>Otsu thresholding</em>, which we
will look at now.</p>
<p>Let’s go ahead and apply this to our blurred image:</p>
<ul><li>Select ‘nuclei_gaussian_σ=3.0’ in the <code>Image</code> row</li>
<li>Select ‘otsu’ as the method</li>
<li>Click the ‘Apply Thresholding’ button</li>
</ul><figure><img src="fig/threshold-blurred-otsu-mask.png" style="width:60.0%" alt="Mask of nuclei (brown) overlaid on  nuclei image - created with Otsu thresholding after gaussian blur" class="figure mx-auto d-block"></figure><p>This should produce a mask (in a new layer ending with
‘threshold_otsu’) that is very similar to the one we created with a
manual threshold. To make it easier to compare, we can rename some of
our layers by double clicking on their name in the layer list - for
example, rename ‘mask’ to ‘manual_mask’, ‘blurred_mask’ to
‘manual_blurred_mask’, and ‘…threshold_otsu’ to ‘otsu_blurred_mask’.
Recall that you can change the colour of a mask by clicking the <img src="https://raw.githubusercontent.com/napari/napari/main/src/napari/resources/icons/shuffle.svg" alt="A screenshot of Napari's shuffle button" height="30" class="figure"> icon in
the top row of the layer controls. By toggling on/off the relevant <img src="https://raw.githubusercontent.com/napari/napari/main/src/napari/resources/icons/visibility.svg" alt="A screenshot of Napari's eye button" height="30" class="figure"> icons, you
should see that Otsu chooses a slightly different threshold than we did
in our ‘manual_blurred_mask’, labelling slightly smaller regions as
nuclei in the final result.</p>
<p>How is Otsu finding the correct threshold? The details are rather
complex, but to summarise - Otsu’s method is trying to find a threshold
that minimises the spread of pixel values in both the background and
your class of interest. In effect, it’s trying to find two peaks in the
image histogram and place a threshold in between them.</p>
<p>This means it’s most suitable for images that show two clear peaks in
their histogram (also known as a ‘bimodal’ histogram). Other images may
require different automated thresholding methods to produce a good
result.</p>
<div id="automated-thresholding-1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<span class="callout-header">Challenge</span>
<div id="automated-thresholding-1" class="callout-inner">
<h3 class="callout-title">Automated thresholding</h3>
<div class="callout-content">
<p>For this exercise, we’ll use the same example image as the <a href="#manual-thresholds">manual thresholding exercise</a>. If you don’t
have that image open, run the top code block in that exercise to open
the image:</p>
<figure><img src="fig/shapes.png" style="width:50.0%" alt="Test image containing a rectangle, circle and triangle" class="figure mx-auto d-block"></figure><p>Try some of the other automatic thresholding options provided by the
<code>napari-skimage</code> plugin. Set the ‘method’ to different
options in
<code>Layers &gt; Filter &gt; Thresholding &gt; Automated Threshold (napari skimage)</code></p>
<p>Try:</p>
<ul><li><code>mean</code></li>
<li><code>yen</code></li>
<li><code>li</code></li>
<li><code>sauvola</code></li>
</ul><p>How do they compare to <code>otsu</code> thresholding?</p>
<p>Recall that you can change the colour of a mask by clicking the <img src="https://raw.githubusercontent.com/napari/napari/main/src/napari/resources/icons/shuffle.svg" alt="A screenshot of Napari's shuffle button" height="30" class="figure"> icon in
the top row of the layer controls.</p>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3"> Show me the solution </h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" aria-labelledby="headingSolution3" data-bs-parent="#accordionSolution3">
<div class="accordion-body">
<figure><img src="fig/shapes-thresholds.png" alt="Masks via automated thresholding" class="figure mx-auto d-block"></figure><ul><li>
<strong>Otsu</strong>: The mask does not include the low‑intensity
triangle.</li>
<li>
<strong>Mean</strong>: Generally good, but on close inspection a few
darker triangle pixels are still missed.</li>
<li>
<strong>Li</strong>: This looks great! The mask includes all pixels
of the three shapes, while excluding the background.</li>
<li>
<strong>Yen</strong>: Includes the shapes but also includes some
background.</li>
<li>
<strong>Sauvola</strong>: A substantial amount of background is
included here.</li>
</ul><p>The important point is that different automatic thresholding methods
will work well for different kinds of images, and depending on which
part of an image you are trying to segment. It’s worth trying a variety
of options on your images to see which performs best for your specific
dataset.</p>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a></h2>
<hr class="half-width"><p>To summarise, here are some of the main steps you can use to make a
mask:</p>
<ol style="list-style-type: decimal"><li>Quality control</li>
<li>Blur the image</li>
<li>Threshold the image</li>
</ol><p>There are many variations on this standard workflow e.g. different
filters could be used to blur the image (or in general to remove noise),
different methods could be used to automatically find a good threshold…
There’s also a wide variety of post processing steps you could use to
make your mask as clean as possible. We’ll look at some of these options
in the next episode.</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<span class="callout-header">Key Points</span>
<div class="callout-inner">
<div class="callout-content">
<ul><li><p>Thresholding is simply choosing a specific pixel value to use as
the cut-off between background and your class of interest.</p></li>
<li><p>Thresholds can be chosen manually based on the image
histogram</p></li>
<li><p>Thresholds can be chosen automatically with various methods
e.g. Otsu</p></li>
<li><p>Filters modify pixel values in an image by using a specific
‘kernel’</p></li>
<li><p>Gaussian filters are useful to blur an image before thresholding.
The ‘sigma’ controls the strength of the blurring effect.</p></li>
<li><p>Image processing operations may modify the data type of your
image - often converting it to <code>float32</code> or
<code>float64</code>.</p></li>
</ul></div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></div> <!-- / div.lesson-content -->
    </main><!-- / main#main-content.main-content --><nav class="bottom-pagination mx-md-4" aria-label="Previous and Next Chapter"><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="quality-control-and-manual-segmentation.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="instance-segmentation-and-measurements.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="quality-control-and-manual-segmentation.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Previous: Quality control and
        </a>
        <a class="chapter-link float-end" href="instance-segmentation-and-measurements.html" rel="next">
          Next: Instance...
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
    </nav></div> <!-- / div.primary-content.col-xs-12 -->
<!-- END:   inst/pkgdown/templates/content-instructor.html-->

      </div><!--/div.row-->
      		<footer class="row footer mx-md-3"><hr><div class="col-md-6">
        <p>This lesson is subject to the <a href="CODE_OF_CONDUCT.html">Code of Conduct</a></p>
        <p>

        <a href="https://github.com/HealthBioscienceIDEAS/microscopy-novice/edit/main/episodes/filters-and-thresholding.md" class="external-link">Edit on GitHub</a>

	
        | <a href="https://github.com/HealthBioscienceIDEAS/microscopy-novice/blob/main/CONTRIBUTING.md" class="external-link">Contributing</a>
        | <a href="https://github.com/HealthBioscienceIDEAS/microscopy-novice/" class="external-link">Source</a></p>
				<p><a href="https://github.com/HealthBioscienceIDEAS/microscopy-novice/blob/main/" class="external-link">Cite</a> | <a href="mailto:team@carpentries.org">Contact</a> | <a href="https://carpentries.org/about/" class="external-link">About</a></p>
			</div>
			<div class="col-md-6">

        <p>Materials licensed under <a href="LICENSE.html">CC-BY 4.0</a> by the authors</p>

        <p>Template licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">CC-BY 4.0</a> by <a href="https://carpentries.org/" class="external-link">The Carpentries</a></p>
        <p>Built with <a href="https://github.com/carpentries/sandpaper/tree/0.18.4" class="external-link">sandpaper (0.18.4)</a>, <a href="https://github.com/carpentries/pegboard/tree/0.7.9" class="external-link">pegboard (0.7.9)</a>, and <a href="https://github.com/HealthBioscienceIDEAS/varnish/tree/IDEAS" class="external-link">varnish (1.0.3.9000)</a></p>
			</div>
		</footer></div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
      <i class="search-icon" data-feather="arrow-up" role="img" aria-label="Back To Top"></i><br><!-- <span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top --><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "LearningResource",
  "@id": "https://HealthBioscienceIDEAS.github.io/microscopy-novice/filters-and-thresholding.html",
  "inLanguage": "en",
  "dct:conformsTo": "https://bioschemas.org/profiles/LearningResource/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "software, data, lesson, The Carpentries",
  "name": "Filters and thresholding",
  "creativeWorkStatus": "active",
  "url": "https://HealthBioscienceIDEAS.github.io/microscopy-novice/filters-and-thresholding.html",
  "identifier": "https://HealthBioscienceIDEAS.github.io/microscopy-novice/filters-and-thresholding.html",
  "dateCreated": "2023-10-26",
  "dateModified": "2025-11-21",
  "datePublished": "2026-01-27"
}

  </script><script>
		feather.replace();
	</script></body></html><!-- END:   inst/pkgdown/templates/layout.html-->

